name: Build and Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.target }} - ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Windows GNU
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            profile: debug
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            profile: release

          # Linux GNU
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            profile: debug
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            profile: release

          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            profile: debug
          - os: macos-latest
            target: x86_64-apple-darwin
            profile: release

          # macOS ARM
          - os: macos-latest
            target: aarch64-apple-darwin
            profile: debug
          - os: macos-latest
            target: aarch64-apple-darwin
            profile: release

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install MinGW for windows-gnu
        if: contains(matrix.target, 'windows-gnu')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-toolchain

      - name: Build (cargo)
        shell: bash
        run: |
          set -e
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --target ${{ matrix.target }} --release
          else
            cargo build --target ${{ matrix.target }}
          fi

      - name: Strip release binaries
        if: matrix.profile == 'release'
        shell: bash
        run: |
          set -e
          srcdir="target/${{ matrix.target }}/release"

          echo "Stripping binaries in $srcdir"

          shopt -s nullglob
          for f in "$srcdir"/*; do
            # Only strip actual binary files
            [ -f "$f" ] || continue

            case "${{ matrix.target }}" in
              *windows-gnu*)
                echo "Stripping (mingw) $f"
                x86_64-w64-mingw32-strip "$f" || true
                ;;
              *unknown-linux-gnu*)
                echo "Stripping (linux) $f"
                strip "$f" || true
                ;;
              *apple-darwin*)
                echo "Stripping (macOS) $f"
                strip -x "$f" || true
                ;;
              *)
                echo "Unknown platform, not stripping."
                ;;
            esac
          done

      - name: Prepare directory structure and copy binaries
        shell: bash
        run: |
          set -e

          outdir="omeganum/lib/${{ matrix.target }}/${{ matrix.profile }}"
          mkdir -p "$outdir"

          srcdir="target/${{ matrix.target }}/${{ matrix.profile }}"
          shopt -s nullglob
          for f in "$srcdir"/*; do
            [ -f "$f" ] || continue
            cp "$f" "$outdir/"
          done

          echo "Copied files into $outdir"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lib-${{ matrix.target }}-${{ matrix.profile }}
          path: omeganum/lib
          if-no-files-found: error


  release:
    name: Build single combined zip and publish
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository (to get omeganum-rs.gdextension)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded_artifacts

      - name: Merge all lib subtrees
        shell: bash
        run: |
          set -e
          mkdir -p omeganum/lib

          for dir in downloaded_artifacts/*; do
            echo "Merging $dir"
            cp -r "$dir/omeganum/lib/"* omeganum/lib/ 2>/dev/null || true
          done

          echo "Final directory tree:"
          find omeganum -maxdepth 4 -type f

      - name: Create final omeganum.zip
        shell: bash
        run: zip -r omeganum.zip omeganum

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: omeganum.zip
