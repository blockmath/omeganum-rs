name: Build and Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.target }} - ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Windows GNU
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            profile: debug
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            profile: release

          # Linux GNU
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            profile: debug
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            profile: release

          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            profile: debug
          - os: macos-latest
            target: x86_64-apple-darwin
            profile: release

          # macOS ARM
          - os: macos-latest
            target: aarch64-apple-darwin
            profile: debug
          - os: macos-latest
            target: aarch64-apple-darwin
            profile: release

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install MinGW for windows-gnu
        if: contains(matrix.target, 'windows-gnu')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-toolchain

      - name: Build (cargo)
        shell: bash
        run: |
          set -e
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --target ${{ matrix.target }} --release
          else
            cargo build --target ${{ matrix.target }}
          fi
      - name: List target directory
        run: |
          echo "=== target (${{ matrix.target }} - ${{ matrix.profile }}) ==="
          find target -maxdepth 4 -type f | sort

      - name: Strip release binaries
        if: matrix.profile == 'release'
        shell: bash
        run: |
          set -e
          srcdir="target/${{ matrix.target }}/release"

          echo "Stripping binaries in $srcdir"

          shopt -s nullglob
          for f in "$srcdir"/*; do
            # Only strip actual binary files
            [ -f "$f" ] || continue

            case "${{ matrix.target }}" in
              *windows-gnu*)
                echo "Stripping (mingw) $f"
                x86_64-w64-mingw32-strip "$f" || true
                ;;
              *unknown-linux-gnu*)
                echo "Stripping (linux) $f"
                strip "$f" || true
                ;;
              *apple-darwin*)
                echo "Stripping (macOS) $f"
                strip -x "$f" || true
                ;;
              *)
                echo "Unknown platform, not stripping."
                ;;
            esac
          done

      - name: Prepare directory structure and copy binaries
        shell: bash
        run: |
          set -e

          outdir="omeganum/libout/${{ matrix.target }}/${{ matrix.profile }}"
          mkdir -p "$outdir"

          srcdir="omeganum/lib/${{ matrix.target }}/${{ matrix.profile }}"
          target="${{ matrix.target }}"
          
          # Determine library filename based on platform
          if [[ "$target" == *"windows"* ]]; then
            # Windows DLL - usually omeganum_rs.dll
            libfile=$(find "$srcdir" -name "*.dll" -type f | head -1)
          elif [[ "$target" == *"darwin"* ]]; then
            # macOS dylib - usually libomeganum_rs.dylib
            libfile=$(find "$srcdir" -name "*.dylib" -type f | head -1)
          else
            # Linux and other Unix-like systems use .so - usually libomeganum_rs.so
            libfile=$(find "$srcdir" -name "*.so" -type f | head -1)
          fi
          
          if [ -n "$libfile" ] && [ -f "$libfile" ]; then
            cp "$libfile" "$outdir/"
            echo "Copied library file: $(basename "$libfile")"
          else
            echo "ERROR: No library file found in $srcdir"
            echo "Directory contents:"
            find "$srcdir" -type f | head -20
            exit 1
          fi
          
          echo "Final directory structure:"
          find "$outdir" -type f

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lib-${{ matrix.target }}-${{ matrix.profile }}
          path: omeganum/libout
          if-no-files-found: error


  release:
    name: Build single combined zip and publish
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository (to get omeganum-rs.gdextension)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded_artifacts

      - name: Merge all lib subtrees
        shell: bash
        run: |
          set -e
          mkdir -p omeganum/lib

          for dir in downloaded_artifacts/*; do
            echo "Merging $dir ; Directory contents:"
            ls "$dir"
            cp -r "$dir/*/" omeganum/lib/ 2>/dev/null || true
          done

          echo "Final directory tree:"
          find omeganum -maxdepth 4 -type f

      - name: Create final omeganum.zip
        shell: bash
        run: zip -r omeganum.zip omeganum

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: omeganum.zip
